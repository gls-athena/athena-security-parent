# å·¥ä½œæµåç§°ï¼šCD - Master Branch Release
# ä½œç”¨ï¼šåœ¨ master åˆ†æ”¯æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œç‰ˆæœ¬å‘å¸ƒæµç¨‹ã€‚
# åŒ…æ‹¬ç‰ˆæœ¬å·è®¡ç®—ã€æ„å»ºæ‰“åŒ…ã€ç”Ÿæˆ Release Notesã€åˆ›å»º GitHub Releaseã€éƒ¨ç½²åˆ° Maven ä»“åº“ç­‰æ“ä½œã€‚

name: CD - Master Branch Release

# è§¦å‘æ¡ä»¶é…ç½®
# æ”¯æŒä¸¤ç§è§¦å‘æ–¹å¼ï¼š
# 1. å½“å‘ master åˆ†æ”¯æ¨é€ä»£ç æ—¶è‡ªåŠ¨è§¦å‘ï¼›
# 2. æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©ç‰ˆæœ¬é€’å¢ç±»å‹ï¼ˆpatch/minor/majorï¼‰ã€‚
on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

# æƒé™é…ç½®ï¼šæˆäºˆå·¥ä½œæµå¯¹ä»“åº“å†…å®¹ã€åŒ…ã€é—®é¢˜å’Œæ‹‰å–è¯·æ±‚çš„å†™æƒé™ã€‚
permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡ï¼ˆjobsï¼‰
jobs:
  # ä»»åŠ¡åç§°ï¼šrelease
  # åŠŸèƒ½ï¼šæ‰§è¡Œå®Œæ•´çš„å‘å¸ƒæµç¨‹ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ç®¡ç†ã€æ„å»ºã€å‘å¸ƒå’Œéƒ¨ç½²ã€‚
  release:
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      # ä½¿ç”¨ actions/checkout æ£€å‡ºæ•´ä¸ª Git å†å²ä»¥æ”¯æŒæ ‡ç­¾æ¯”è¾ƒç­‰æ“ä½œã€‚
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè®¾ç½® JDK ç¯å¢ƒ
      # é…ç½® Java 21 ç¯å¢ƒï¼Œå¹¶å¯ç”¨ Maven ç¼“å­˜ä»¥åŠ é€Ÿæ„å»ºã€‚
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # æ­¥éª¤3ï¼šé…ç½® Git ç”¨æˆ·ä¿¡æ¯
      # è®¾ç½® Git æäº¤æ‰€éœ€çš„å…¨å±€ç”¨æˆ·ä¿¡æ¯ã€‚
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # æ­¥éª¤4ï¼šè·å–å½“å‰ç‰ˆæœ¬å·
      # ä» pom.xml ä¸­è¯»å– revision å±æ€§å¹¶å»é™¤ SNAPSHOT åç¼€ä½œä¸ºå½“å‰ç‰ˆæœ¬ã€‚
      - name: Get current version
        id: current_version
        run: |
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=revision -q -DforceStdout | sed 's/-SNAPSHOT//')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      # æ­¥éª¤5ï¼šè®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
      # æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç‰ˆæœ¬ç±»å‹ï¼ˆmajor/minor/patchï¼‰è®¡ç®—å‘å¸ƒç‰ˆæœ¬ä¸ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ã€‚
      - name: Calculate next version
        id: next_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current }}"
          VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
          
          # å½“å‰ç‰ˆæœ¬å°±æ˜¯è¦å‘å¸ƒçš„ç‰ˆæœ¬ï¼ˆå»æ‰SNAPSHOTåç¼€ï¼‰
          RELEASE_VERSION="$CURRENT_VERSION"
          
          # è§£æç‰ˆæœ¬å·ç”¨äºè®¡ç®—ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          IFS='.' read -ra VERSION_PARTS <<< "$RELEASE_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # æ ¹æ®ç±»å‹é€’å¢ç‰ˆæœ¬æ¥è®¡ç®—ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEXT_SNAPSHOT_VERSION="$MAJOR.$MINOR.$PATCH-SNAPSHOT"
          
          echo "next=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "next_snapshot=$NEXT_SNAPSHOT_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $RELEASE_VERSION"
          echo "Next development version: $NEXT_SNAPSHOT_VERSION"

      # æ­¥éª¤6ï¼šç”Ÿæˆ Release Notes
      # é€šè¿‡ Git æ—¥å¿—æå–è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤è®°å½•ï¼Œç”¨äºç”Ÿæˆ Release Notesã€‚
      - name: Generate release notes from git log
        id: release_notes
        run: |
          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„æ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # è·å–ä»ä¸Šä¸€ä¸ªæ ‡ç­¾åˆ°å½“å‰HEADçš„æäº¤æ—¥å¿—
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --oneline --no-merges --format="- %s (%h)" | head -50)
            echo "Found commits since $PREVIOUS_TAG:"
            echo "$COMMITS"
          else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸Šä¸€ä¸ªæ ‡ç­¾ï¼Œè·å–æœ€è¿‘çš„10ä¸ªæäº¤
            COMMITS=$(git log HEAD --oneline --no-merges --format="- %s (%h)" | head -10)
            echo "No previous tags found, showing recent commits:"
            echo "$COMMITS"
          fi
          
          # ä¿å­˜åˆ°è¾“å‡ºå˜é‡ï¼Œå¤„ç†å¤šè¡Œæ–‡æœ¬
          {
            echo 'commits<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT
          
          # ä¿å­˜ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¿¡æ¯
          echo "previous_tag=${PREVIOUS_TAG:-'Initial release'}" >> $GITHUB_OUTPUT

      # æ­¥éª¤7ï¼šè¿è¡Œæµ‹è¯•
      # åœ¨å‘å¸ƒå‰è¿è¡Œå•å…ƒæµ‹è¯•ä»¥ç¡®ä¿ä»£ç è´¨é‡ã€‚
      - name: Run tests before release
        run: |
          mvn clean test -Drevision=${{ steps.next_version.outputs.next }}

      # æ­¥éª¤8ï¼šæ›´æ–° pom.xml ä¸­çš„ revision å±æ€§ä¸ºå‘å¸ƒç‰ˆæœ¬
      - name: Update revision property for release
        run: |
          # æ›´æ–° pom.xml ä¸­çš„ revision å±æ€§è€Œä¸æ˜¯ version
          sed -i "s/<revision>.*<\/revision>/<revision>${{ steps.next_version.outputs.next }}<\/revision>/g" pom.xml

      # æ­¥éª¤9ï¼šæ„å»ºå¹¶æ‰“åŒ…é¡¹ç›®
      - name: Build and package
        run: |
          mvn clean package -DskipTests -Drevision=${{ steps.next_version.outputs.next }}

      # æ­¥éª¤10ï¼šæäº¤å‘å¸ƒç‰ˆæœ¬æ›´æ”¹
      - name: Commit release version
        run: |
          git add .
          git commit -m "Release version ${{ steps.next_version.outputs.next }}" || echo "No changes to commit"

      # æ­¥éª¤11ï¼šåˆ›å»ºå‘å¸ƒæ ‡ç­¾
      - name: Create release tag
        run: |
          git tag -a "v${{ steps.next_version.outputs.next }}" -m "Release version ${{ steps.next_version.outputs.next }}"

      # æ­¥éª¤12ï¼šæ›´æ–° pom.xml ä¸­çš„ revision å±æ€§ä¸ºä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
      - name: Update revision property for next development version
        run: |
          # æ›´æ–° revision å±æ€§ä¸ºä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬
          sed -i "s/<revision>.*<\/revision>/<revision>${{ steps.next_version.outputs.next_snapshot }}<\/revision>/g" pom.xml

      # æ­¥éª¤13ï¼šæäº¤ä¸‹ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬æ›´æ”¹
      - name: Commit next development version
        run: |
          git add .
          git commit -m "Prepare for next development iteration ${{ steps.next_version.outputs.next_snapshot }}" || echo "No changes to commit"

      # æ­¥éª¤14ï¼šæ¨é€æ›´æ”¹å’Œæ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
      - name: Push changes and tags
        run: |
          git push origin master
          git push origin "v${{ steps.next_version.outputs.next }}"

      # æ­¥éª¤15ï¼šå°† master çš„å˜æ›´åŒæ­¥å› develop åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Sync changes back to develop branch
        run: |
          # æ£€æŸ¥developåˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "Develop branch exists, syncing changes..."
          
            # åˆ‡æ¢åˆ°developåˆ†æ”¯
            git checkout develop
            git pull origin develop
          
            # åˆå¹¶masteråˆ†æ”¯çš„å˜æ›´åˆ°develop
            git merge master --no-ff -m "Sync release v${{ steps.next_version.outputs.next }} changes back to develop"
          
            # æ¨é€developåˆ†æ”¯
            git push origin develop
          
            echo "âœ… Successfully synced changes to develop branch"
          else
            echo "âš ï¸ Develop branch does not exist, skipping sync"
          fi

      # æ­¥éª¤16ï¼šåˆ›å»º GitHub Release
      # ä½¿ç”¨ GitHub CLI åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ Release Notes å’Œä¾èµ–ç¤ºä¾‹çš„ GitHub Releaseã€‚
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨release notes
          cat > release_notes.md << 'EOF'
          ## Release Notes for v${{ steps.next_version.outputs.next }}
          
          **Release Type:** ${{ github.event.inputs.version_type || 'patch' }} version increment
          **Previous Version:** ${{ steps.release_notes.outputs.previous_tag }}
          
          ### ğŸš€ What's Changed
          ${{ steps.release_notes.outputs.commits }}
          
          ### ğŸ“¦ Artifacts
          This release includes all Maven modules in the athena-parent project.
          
          ### ğŸ’¾ Installation
          ```xml
          <dependency>
              <groupId>io.github.gls-athena.security</groupId>
              <artifactId>athena-security-bom</artifactId>
              <version>${{ steps.next_version.outputs.next }}</version>
              <type>pom</type>
              <scope>import</scope>
          </dependency>
          ```
          
          ### ğŸ“ Full Changelog
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.release_notes.outputs.previous_tag }}...v${{ steps.next_version.outputs.next }}
          EOF
          
          # ä½¿ç”¨æ–‡ä»¶åˆ›å»ºrelease
          gh release create "v${{ steps.next_version.outputs.next }}" \
            --title "Release v${{ steps.next_version.outputs.next }}" \
            --notes-file release_notes.md

      # æ­¥éª¤17ï¼šè®¾ç½® GPG ç¯å¢ƒï¼ˆå¦‚æœéœ€è¦éƒ¨ç½²åˆ° Maven ä»“åº“ï¼‰
      - name: Setup GPG for Maven deployment
        if: env.MAVEN_USERNAME != '' && env.MAVEN_PASSWORD != ''
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "Setting up GPG for artifact signing..."
          
            # å¯¼å…¥ GPG ç§é’¥
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import --no-tty
          
            # è·å–å¯†é’¥ ID (ä¿®å¤ç‰ˆæœ¬)
            GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep -A1 "sec" | grep -E "^\s*[A-F0-9]+" | head -1 | awk '{print $1}' | cut -d'/' -f2)
          
            # å¦‚æœä¸Šé¢çš„æ–¹æ³•å¤±è´¥ï¼Œå°è¯•å¦ä¸€ç§æ–¹æ³•
            if [ -z "$GPG_KEY_ID" ]; then
              GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep "sec" | head -1 | sed 's/.*\/\([A-F0-9]*\).*/\1/')
            fi
          
            echo "GPG Key ID: $GPG_KEY_ID"
          
            # é…ç½® GPG ä¿¡ä»» (åªæœ‰å½“è·å–åˆ°æœ‰æ•ˆå¯†é’¥ ID æ—¶)
            if [ -n "$GPG_KEY_ID" ] && [ "$GPG_KEY_ID" != "" ]; then
              echo "$GPG_KEY_ID:6:" | gpg --import-ownertrust --no-tty
              echo "âœ… GPG trust configured for key: $GPG_KEY_ID"
            else
              echo "âš ï¸ Could not extract GPG key ID, skipping trust configuration"
            fi
          
            # æµ‹è¯• GPG ç­¾ååŠŸèƒ½
            echo "test" | gpg --batch --yes --passphrase "$GPG_PASSPHRASE" --pinentry-mode loopback --sign --armor > /dev/null
          
            echo "âœ… GPG setup completed successfully"
          else
            echo "âš ï¸ GPG_PRIVATE_KEY not found - GPG signing will be skipped"
          fi

      # æ­¥éª¤18ï¼šéƒ¨ç½²åˆ° Maven ä»“åº“
      # å¦‚æœé…ç½®äº† Maven å‡­æ®ï¼Œåˆ™å°†æ„å»ºäº§ç‰©éƒ¨ç½²åˆ°æŒ‡å®šçš„ Maven ä»“åº“ä¸­ã€‚
      - name: Deploy to Maven Repository
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -n "$MAVEN_USERNAME" ] && [ -n "$MAVEN_PASSWORD" ]; then
            echo "Deploying to Maven Repository..."
            mvn deploy -DskipTests -Drevision=${{ steps.next_version.outputs.next }} -Prelease \
              -s .github/settings.xml \
              -Dmaven.repo.username=$MAVEN_USERNAME \
              -Dmaven.repo.password=$MAVEN_PASSWORD \
              -Dgpg.passphrase=$GPG_PASSPHRASE
          else
            echo "Maven deployment skipped - credentials not configured"
          fi

  # ä»»åŠ¡åç§°ï¼šnotify
  # åŠŸèƒ½ï¼šåœ¨ release ä»»åŠ¡å®Œæˆåå‘é€é€šçŸ¥ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ã€‚
  notify:
    runs-on: ubuntu-latest
    needs: release
    if: always()

    steps:
      # æˆåŠŸé€šçŸ¥
      - name: Notify on success
        if: needs.release.result == 'success'
        run: |
          echo "âœ… Release completed successfully!"
          echo "New version: v${{ needs.release.outputs.next_version }}"

      # å¤±è´¥é€šçŸ¥
      - name: Notify on failure
        if: needs.release.result == 'failure'
        run: |
          echo "âŒ Release failed!"
          echo "Please check the logs and fix any issues."
